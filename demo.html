<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>LIPS Demo</title>
    <link href="https://rawgit.com/jcubic/jquery.terminal/master/css/jquery.terminal.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://rawgit.com/jcubic/jquery.terminal/master/js/jquery.terminal.js"></script>
    <script src="https://rawgit.com/inexorabletash/polyfill/master/keyboard.js"></script>
    <script src="https://unpkg.com/prismjs@1.8.1/prism.js"></script>
    <link href="https://unpkg.com/prismjs@1.8.1/themes/prism.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal@1.16.1/js/prism.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.14.0/components/prism-scheme.js"></script>
    <style>
     .token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string {
         background: inherit;
     }
     html, body {
         height: 100%;
     }
    </style>
  </head>
  <body></body>
  <script>
   var greetings = 'LIPS is Pretty Simple - Scheme like Lisp Interpreter\n' +
                   'type [[b;#fff;](env)] to see environment with ' +
                   'functions macros and variables\n';
   window.onerror = function(message, source, lineno, colno,) {
       message += ' ' + 'in file ' + source + ' line ' + lineno +
                  '\nYour browser may not support ES6.';
       var term = $('body');
       if (term.hasClass('terminal')) {
           $.terminal.active().error(message);
       } else {
           window.term = $('body').terminal(function() {
               this.error('You need to use modern browser');
           }, {
               greetings: false
           }).error(message);
       }
   };
  </script>
  <script src="src/lips.js"></script>
  <script>
   (function() {
       $.terminal.defaults.formatters.push($.terminal.prism.bind(null, "scheme"));
       var {
           Environment,
           global_environment,
           balanced_parenthesis,
           tokenize,
           parse,
           evaluate
       } = lips;
       var env = new Environment({
           stdout: {
               write: function(...args) {
                   args.forEach((arg) => {
                       term.echo(arg, {keepWords: true});
                   });
               }
           },
           stdin: {
               read: function() {
                   return new Promise(function(resolve) {
                       term.read('', function(command) {
                           resolve(command);
                       });
                   });
               }
           }
       }, global_environment);
       var position;
       var timer;
       window.term = $('body').terminal(function(code, term) {
           if (!balanced_parenthesis(code)) {
               term.error('Unbalanced parenthesis');
           } else {
               parse(tokenize(code)).forEach(function(code) {
                   try {
                       var ret = evaluate(code, env);
                       if (ret instanceof Promise) {
                           ret.then((ret) => {
                               if (ret !== undefined) {
                                   env.get('print').call(env, ret)
                               }
                           });
                       } else if (ret !== undefined) {
                           env.get('print').call(env, ret);
                       }
                   } catch (e) {
                       term.error(e.message);
                   }
               });
           }
       }, {
           name: 'lisp',
           prompt: 'lips> ',
           enabled: false,
           greetings: '',
           keydown: function() {
               if (position) {
                   term.set_position(position);
                   position = false;
               }
           },
           keypress: function(e) {
               var term = this;
               if (e.key == ')') {
                   setTimeout(function() {
                       position = term.get_position();
                       var command = term.get_command().substring(0, position);
                       var len = command.split(/\n/)[0].length;
                       var tokens = tokenize(command, true);
                       var count = 1;
                       var token;
                       var i = tokens.length - 1;
                       while (count > 0) {
                           token = tokens[--i];
                           if (!token) {
                               return;
                           }
                           if (token.token === '(') {
                               count--;
                           } else if (token.token == ')') {
                               count++;
                           }
                       }
                       if (token.token == '(' && count === 0) {
                           clearTimeout(timer);
                           setTimeout(function() {
                               term.set_position(token.offset);
                               timer = setTimeout(function() {
                                   term.set_position(position)
                                   position = false;
                               }, 200);
                           }, 0);
                       }
                   }, 0);
               } else {
                   position = false;
               }
           }
       });
   })();
  </script>
  <script type="text-x/lips">
   ;; Example of LIPS in script tag
   (load "greetings.lips")
   (let* ((res (fetch "greetings.lips"))
          (text ((. res "text")))
          (log (. console "log")))
       (log text))
  </script>
</html>
